apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: aggregator
  namespace: web
spec:
  virtualhost:
    fqdn: aggregator.${DOMAIN_NAME}
    tls:
      secretName: aggregator
    authorization:
      extensionRef:
        name: oidc
        namespace: contour-auth
  routes:
    - services:
      - name: aggregator
        port: 8080
---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: aks-helloworld
  namespace: default
spec:
  virtualhost:
    fqdn: aks-helloworld.${DOMAIN_NAME}
  includes:
  - name: default-web
    namespace: default
---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: default-web
  namespace: default
spec:
  routes:
    - services:
      - name: aks-helloworld
        port: 80
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: aggregator
  namespace: web
spec:
  commonName: aggregator.${DOMAIN_NAME}
  dnsNames:
  - aggregator.${DOMAIN_NAME}
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  secretName: aggregator